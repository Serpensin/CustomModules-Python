# Publish to PyPI using Trusted Publishing (OIDC)
#
# This workflow uses PyPI's Trusted Publishing feature for secure, token-free publishing.
# 
# Setup (one-time):
# 1. Go to https://pypi.org/manage/account/publishing/
# 2. Add a pending publisher with:
#    - PyPI Project Name: CustomModules
#    - Owner: Serpensin
#    - Repository: CustomModules-Python
#    - Workflow: publish-pypi.yml
#    - Environment: pypi
# 3. Create your first release - the pending publisher will be activated
#
# See TRUSTED_PUBLISHING.md for detailed instructions.

name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-and-publish:
    name: Build and publish Python distribution to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/CustomModules
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper version detection

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel

    - name: Update version in files
      if: github.event_name == 'workflow_dispatch'
      run: |
        VERSION="${{ github.event.inputs.version }}"
        # Update setup.py
        sed -i "s/version='[^']*'/version='$VERSION'/" setup.py
        # Update pyproject.toml
        sed -i "s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
        # Update __init__.py
        sed -i "s/__version__ = '[^']*'/__version__ = '$VERSION'/" CustomModules/__init__.py

    - name: Extract version from tag
      if: github.event_name == 'release'
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        # Update setup.py
        sed -i "s/version='[^']*'/version='$VERSION'/" setup.py
        # Update pyproject.toml
        sed -i "s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
        # Update __init__.py
        sed -i "s/__version__ = '[^']*'/__version__ = '$VERSION'/" CustomModules/__init__.py

    - name: Verify package structure
      run: |
        echo "Checking package structure..."
        ls -la
        echo "CustomModules directory:"
        ls -la CustomModules/
        echo "Module directories:"
        for dir in AppTranslation BitmapHandler BotDirectory DatabaseHandler Googletrans InviteTracker Killswitch Libretrans LogHandler Patchnotes PrivateVoice RandomUsernames StatDock Steam SteamCharts Twitch; do
          if [ -d "$dir" ]; then
            echo "$dir exists"
          else
            echo "Warning: $dir does not exist"
          fi
        done

    - name: Build package
      run: |
        python -m build
        echo "Built packages:"
        ls -la dist/

    - name: Check distribution
      run: |
        twine check dist/*

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      # No credentials needed - uses Trusted Publishing (OIDC)
      # Configure at: https://pypi.org/manage/account/publishing/
